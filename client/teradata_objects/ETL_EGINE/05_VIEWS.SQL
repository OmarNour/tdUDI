REPLACE VIEW /*VER.01*/ GDEV1V_GCFR.PROCESS AS LOCK ROW FOR ACCESS 
WITH CTE_KEY_COLS as
(
	SELECT DB_NAME, TABLE_NAME
		, TRIM( TRAILING  ',' FROM (XMLAGG(trim(KEY_COLUMN)|| ',' ORDER BY KEY_COLUMN) (VARCHAR(10000)))) KEY_COLUMNS
		, OREPLACE(TRIM( TRAILING  ',' FROM (XMLAGG('X.'||KEY_COLUMN||' = Y.'||KEY_COLUMN || ',' ORDER BY KEY_COLUMN) (VARCHAR(10000)))), ', ', ' AND ' ) KEY_COLUMNS_JOIN
	FROM GDEV1T_GCFR.TRANSFORM_KEYCOL X
	WHERE NOT EXISTS (
						SELECT 1 
						FROM GDEV1T_GCFR.CORE_TABLES Y 
						WHERE X.DB_NAME='GDEV1T_BASE'
						AND Y.TABLE_NAME=X.TABLE_NAME
						AND Y.START_DATE_COLUMN = X.KEY_COLUMN
						AND Y.IS_HISTORY = 1
					)
	GROUP BY DB_NAME, TABLE_NAME
)
, CTE_HISTORY_COLS AS
(
	SELECT PROCESS_NAME
	, TRIM( TRAILING  ',' FROM (XMLAGG(trim(HISTORY_COLUMN)|| ',' ORDER BY HISTORY_COLUMN) (VARCHAR(10000)))) HISTORY_COLUMNS
	FROM GDEV1T_GCFR.HISTORY
	GROUP BY PROCESS_NAME
)
, CTE_NORMAL_COMMON_COLS as
(
	SELECT
	PROCESS_NAME
	, TRIM( TRAILING  ',' FROM (XMLAGG(trim(columnname)|| ',' ORDER BY columnname) (VARCHAR(10000)))) NORMAL_COMMON_COLUMNS
	FROM 
	(
		select P.PROCESS_NAME, V.columnname 
		from dbc.columnsv v
		join GDEV1T_GCFR.PROCESS P 
		on P.SRC_DB=v.databasename and P.SRC_TABLE=v.tablename
		and V.columnname not in ('BATCH_ID', 'MODIFICATION_TYPE', 'REF_KEY')
		
		INTERSECT
		
		select P.PROCESS_NAME, columnname 
		from dbc.columnsv v
		join GDEV1T_GCFR.PROCESS P 
		on P.TGT_DB=v.databasename and P.TGT_TABLE=v.tablename
		AND NOT EXISTS (
							SELECT 1 
							FROM GDEV1T_GCFR.CORE_TABLES Y 
							WHERE v.databasename='GDEV1T_BASE'
							AND v.tablename=y.TABLE_NAME
							AND v.columnname = Y.START_DATE_COLUMN
							AND Y.IS_HISTORY = 1
							AND P.APPLY_TYPE = 'HISTORY'
						)
		AND NOT EXISTS (
							SELECT 1 
							FROM GDEV1T_GCFR.TRANSFORM_KEYCOL Y 
							WHERE v.databasename=Y.DB_NAME
							AND v.tablename=y.TABLE_NAME
							AND v.columnname = Y.KEY_COLUMN
						)
		AND NOT EXISTS (
							SELECT 1 
							FROM GDEV1T_GCFR.HISTORY Y 
							WHERE P.PROCESS_NAME=y.PROCESS_NAME
							AND v.columnname = Y.HISTORY_COLUMN
							AND P.APPLY_TYPE = 'HISTORY'
						)
	) X
	GROUP BY PROCESS_NAME
)
SELECT
	P.PROCESS_NAME,
    P.PROCESS_TYPE,
    P.SOURCE_NAME,
    P.SRC_DB,
    P.SRC_TABLE,
    P.TGT_DB,
    P.TGT_TABLE,
   	KC.KEY_COLUMNS,
   	KC.KEY_COLUMNS_JOIN,
   	CTBL.START_DATE_COLUMN,
    HC.HISTORY_COLUMNS,
    P.APPLY_TYPE,
    P.KEY_SET_ID,
    P.CODE_SET_ID,
    P.DOMAIN_ID,
    P.ACTIVE,
    NCC.NORMAL_COMMON_COLUMNS
FROM GDEV1T_GCFR.PROCESS P
	
	LEFT JOIN CTE_KEY_COLS KC
	ON P.TGT_DB=KC.DB_NAME
	AND P.TGT_TABLE=KC.TABLE_NAME
	
	LEFT JOIN GDEV1T_GCFR.CORE_TABLES CTBL
	ON CTBL.TABLE_NAME=P.TGT_TABLE
	AND P.TGT_DB = 'GDEV1T_BASE'
	AND CTBL.IS_HISTORY = 1
	AND P.APPLY_TYPE = 'HISTORY'
	
	LEFT JOIN CTE_HISTORY_COLS HC
	ON HC.PROCESS_NAME=P.PROCESS_NAME
	
	LEFT JOIN CTE_NORMAL_COMMON_COLS NCC
	ON NCC.PROCESS_NAME=P.PROCESS_NAME;


